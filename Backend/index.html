<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pruebas de Autenticación - API Pyme</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-top: 20px; }
        input[type="email"], input[type="password"], button { width: 100%; padding: 10px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #5cb85c; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #4cae4c; }
        #output { margin-top: 20px; padding: 10px; border: 1px solid #ddd; background-color: #e9e9e9; white-space: pre-wrap; word-break: break-all; }
        .token-display { background-color: #f0f0f0; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.9em; word-break: break-all; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
</head>
<body>

<div class="container">
    <h1>API Pyme - Pruebas de Autenticación Local</h1>

    <h2>Token JWT Activo (Para pruebas de acceso)</h2>
    <div class="token-display" id="current-token">Ningún token activo.</div>

    <h2>1. Registro Inicial (Llama a Flask: /setup-user)</h2>
    <input type="email" id="reg-email" placeholder="Correo Electrónico">
    <input type="password" id="reg-password" placeholder="Contraseña (mín. 6 caracteres)">
    <button onclick="handleRegister()">Registrar Usuario</button>

    <hr>

    <h2>2. Iniciar Sesión (Obtiene el Token de Firebase)</h2>
    <input type="email" id="log-email" placeholder="Correo Electrónico">
    <input type="password" id="log-password" placeholder="Contraseña">
    <button onclick="handleLogin()">Iniciar Sesión</button>

    <hr>

    <h2>3. Probar Ruta Protegida (Llama a Flask: /test-pyme-access)</h2>
    <button onclick="handleProtectedRouteTest()">Probar Acceso PYME</button>

    <hr>

    <h2>Salida de la API</h2>
    <div id="output"></div>
</div>
<script>
    // ... (CONFIGURACIÓN DE FIREBASE Y FUNCIONES UTILITARIAS SIN CAMBIOS) ...

    const firebaseConfig = {
      apiKey: "AIzaSyAdfWxmJ__6uqSx0hRLJHWiXBNHWiHJBAs",
      authDomain: "aprendiendo-firebase-e07d9.firebaseapp.com",
      projectId: "aprendiendo-firebase-e07d9",
      storageBucket: "aprendiendo-firebase-e07d9.firebasestorage.app",
      messagingSenderId: "924917737471",
      appId: "1:924917737471:web:491a658d7bd8fee87c69ca"
    };

    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentIdToken = '';
    const FLASK_URL = 'http://127.0.0.1:5000/api/v1/auth';

    function updateTokenDisplay(token) {
        currentIdToken = token;
        document.getElementById('current-token').textContent = token ? token : 'Ningún token activo.';
    }

    function displayOutput(message, isError = false) {
        const output = document.getElementById('output');
        output.innerHTML = `<strong>${isError ? 'ERROR' : 'ÉXITO'}</strong>: ${message}`;
        output.style.color = isError ? 'red' : 'green';
    }

    // ----------------------------------------------------------------------
    // 1. REGISTRO (Llama a FLASK y ENVÍA CORREO DE VERIFICACIÓN)
    // ----------------------------------------------------------------------

    async function handleRegister() {
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;

        if (!email || !password) {
            return displayOutput("Email y contraseña son obligatorios.", true);
        }

        try {
            // PASO 1: Llama al endpoint de Flask (crea usuario en Firebase Admin + perfil en Neon DB)
            const response = await fetch(`${FLASK_URL}/setup-user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (!response.ok) {
                // Maneja errores de Flask (Ej: 409 Email ya existe, 400 Contraseña débil)
                return displayOutput(`[${response.status}] Error de Flask: ${data.msg}`, true);
            }

            // --- LÓGICA DE VERIFICACIÓN DE CORREO (Frontend) ---
            let user;
            try {
                // 2a. Inicia sesión para obtener el objeto User (necesario para sendEmailVerification)
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                user = userCredential.user;

                // 2b. Envía el correo de verificación
                await user.sendEmailVerification();
                
                // 2c. Cierra la sesión (por seguridad)
                await auth.signOut();

                updateTokenDisplay('');
                displayOutput(`🎉 Registro exitoso. **¡IMPORTANTE!** Revisa tu bandeja de entrada (${email}) y haz clic en el enlace para verificar tu cuenta.`, false);
                
            } catch (firebaseSignInError) {
                // **CORRECCIÓN:** Atrapa fallos del signIn, que es lo que te da el error 400
                console.error("Error al intentar iniciar sesión para enviar correo:", firebaseSignInError);

                let msg = "Registro de backend exitoso, pero **no pudimos enviar el correo de verificación** (Error de Firebase Web). Verifica la consola del navegador.";

                if (firebaseSignInError.code === 'auth/user-disabled') {
                    msg = "Registro exitoso, pero la cuenta está deshabilitada. Contacta al administrador.";
                }

                displayOutput(msg, true);
                
                // Asegura que la sesión se cierre en caso de fallo parcial
                if (user) await auth.signOut();
            }

        } catch (error) {
            // Maneja errores de red o conexión con Flask
            displayOutput(`Error de conexión o de red con Flask: ${error.message}. Asegúrate que el servidor Flask esté corriendo.`, true);
        }
    }

    // ----------------------------------------------------------------------
    // 2. LOGIN (Obtiene el Token de Firebase Web)
    // ----------------------------------------------------------------------

    async function handleLogin() {
        const email = document.getElementById('log-email').value;
        const password = document.getElementById('log-password').value;

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            // Opcional: Esto ayuda a tus compañeros a saber si deben verificar
            if (!user.emailVerified) {
                 displayOutput("Advertencia: ¡Tu email no ha sido verificado! El acceso protegido podría ser limitado.", true);
            }

            const token = await user.getIdToken();

            updateTokenDisplay(token);
            displayOutput(`Inicio de sesión exitoso. Token obtenido y almacenado. UID: ${user.uid}`);

        } catch (error) {
            updateTokenDisplay('');
            displayOutput(`Error de Login con Firebase: ${error.message}`, true);
        }
    }

    // ----------------------------------------------------------------------
    // 3. PRUEBA DE RUTA PROTEGIDA (Llama a FLASK enviando el token)
    // ----------------------------------------------------------------------

    async function handleProtectedRouteTest() {
        if (!currentIdToken) {
            return displayOutput("Por favor, inicia sesión primero para obtener un token.", true);
        }

        try {
            const response = await fetch(`${FLASK_URL}/test-pyme-access`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${currentIdToken}`
                }
            });

            const data = await response.json();

            if (!response.ok) {
                displayOutput(`[${response.status}] Acceso Denegado: ${data.msg}.`, true);
            } else {
                displayOutput(`¡Acceso Verificado! Respuesta de Flask: ${JSON.stringify(data, null, 2)}`);
            }

        } catch (error) {
            displayOutput(`Error de conexión o de red: ${error.message}`, true);
        }
    }

</script>


</body>
</html>